# 浏览器渲染机制

## 从浏览器地址栏到显示页面的步骤

### 基本版：
1.  浏览器根据url交给dns域名解析IP，请求服务器
2.  服务器交给后台处理返回业务数据，浏览器接收html、js、css、图片信息
3.  浏览器解析和解压资源（html、js、css、图片），建立内部数据结构如DOM、CSS树
4.  载入资源文件，渲染页面，完成

### 详细版

#### 请求阶段
1. 浏览器输入url
2. 浏览器查看缓存，判断强缓存/协商缓存
3. 解析url、协议、主机ip、端口、路径
4. 组装Http（GET）请求报文
5. 浏览器获取主机ip地址

#### 建立tcp
1. socket与目标ip建立TCP链接，三次握手
   1. 客户端 -> SYN=1, Seq=X -> 服务器
   2. 服务器 -> SYN=1, ACK=1, Seq=Y; ACKnum=X+1 -> 客户端
   3. 客户端 -> ACK=1 ,ACKnum=y+1
2. TCP链接后发送HTTP请求
3. 服务器检查协商缓存，有缓存返回304，无缓存交给处理程序读取请求并返回Http响应报文，期间可能还需要查询数据库
4. 将响应报文通过TCP链接发回浏览器

#### 处理响应
1. 浏览器接收HTTP响应，根据情况关闭TCP连接或者保留重用，关闭TCP链接四次握手
   1. 主动发送 -> Fin=1, Seq=X 报文
   2. 被动方发送 -> Ack=x+1, Seq=Z -> 报文
   3. 被动方发送 -> Fin=1 Ack=X, Seq=Y -> 报文
   4. 客被动方发送 -> ACK=Y Seq=X -> 报文
2. 检查状态码 1XX 3XX 4XX 5XX 分别做不同的处理，其中如果资源可缓存就建立缓存，304使用缓存数据
3. 对缓存进行解码（gzip）

#### 构建数据结构
1. 解析html文档，构建dom树，下载解析css，构造cssom，执行html文本，执行js脚本
2. 显示页面